\documentclass[11.5pt,a4paper]{article}

\setlength{\topmargin}{0cm}
\setlength{\headheight}{0.4cm}
\setlength{\headsep}{0.8cm}
\setlength{\footskip}{1cm}
\setlength{\textwidth}{17cm}
\setlength{\textheight}{25cm}
\setlength{\voffset}{-1.5cm}
\setlength{\hoffset}{-0.5cm}
\setlength{\oddsidemargin}{0cm}
\setlength{\evensidemargin}{0cm}

\usepackage{graphicx} % inclusion des figures
\usepackage{amsmath} % collection de symboles math�matiques
\usepackage{amssymb} % collection de symboles math�matiques
\usepackage{subfigure} % 2 Bilder nebeneinander
\usepackage{placeins} %FloatBarrier

%\usepackage[applemac]{inputenc} % utilisation directe des caract�res accentu�s sur mac
%\usepackage[latin1]{inputenc}   % utilisation directe des caract�res accentu�s sur pc
\usepackage[ansinew]{inputenc}	 % klappt unter windows

\usepackage[german,ngerman, english]{babel} %% Deutsch als Hauptsprache
%\usepackage{epstopdf} % wandelt eps-dateien in pdf-datein um
\usepackage[T1]{fontenc} % codage moderne des caract�res sous Latex

\usepackage{tabularx} % Tabellen mit variabler Spaltenbreite

\usepackage{color} % gestion de diff�rentes couleurs
\definecolor{linkcolor}{rgb}{0,0,0.6} % d�finition de la couleur des liens pdf
\usepackage[ pdftex,colorlinks=true, pdfstartview=FitV,
linkcolor= linkcolor, citecolor= linkcolor, urlcolor= linkcolor,
hyperindex=true, hyperfigures=false]{hyperref} % fichiers pdf 'intelligents', avec des liens entre les r�f�rences, etc.

\usepackage{fancyhdr} % Wahl der Kopf- und Fu�zeile
\pagestyle{headings} %zeigt Seitennummer und Abschnittstitel an

\usepackage[center]{caption}


%\pagestyle{fancy} %manuelle Wahl der Kopf- und Fu�zeile
%\fancyhead[L]{\scriptsize \textsc{Electrical properties of a Carbon Nanotube device under extreme conditions}}
%\fancyhead[R]{\scriptsize \textsc{Mario Bomers}}
%\fancyfoot[C]{ \thepage}

\usepackage[normalem]{ulem}
\usepackage{moreverb}
\usepackage{color}
\usepackage{listings} %code listings
\usepackage{verbatim} %multiline comments
\usepackage{color}
 
\definecolor{dkgreen}{rgb}{0,0.6,0}
\definecolor{gray}{rgb}{0.5,0.5,0.5}
\definecolor{mauve}{rgb}{0.58,0,0.82}

\lstset{ %
  language=Matlab,                % the language of the code
  basicstyle=\footnotesize,           % the size of the fonts that are used for the code
  numbers=left,                   % where to put the line-numbers
  numberstyle=\tiny\color{gray},  % the style that is used for the line-numbers
  stepnumber=1,                   % the step between two line-numbers. If it's 1, each line 
                                  % will be numbered
  numbersep=5pt,                  % how far the line-numbers are from the code
  backgroundcolor=\color{white},      % choose the background color. You must add \usepackage{color}
  showspaces=false,               % show spaces adding particular underscores
  showstringspaces=false,         % underline spaces within strings
  showtabs=false,                 % show tabs within strings adding particular underscores
  frame=single,                   % adds a frame around the code
  rulecolor=\color{black},        % if not set, the frame-color may be changed on line-breaks within not-black text (e.g. commens (green here))
  tabsize=2,                      % sets default tabsize to 2 spaces
  %captionpos=b,                   % sets the caption-position to bottom
  breaklines=true,                % sets automatic line breaking
  breakatwhitespace=false,        % sets if automatic breaks should only happen at whitespace
  %title=\lstname,                   % show the filename of files included with \lstinputlisting;
                                  % also try caption instead of title
  keywordstyle=\color{blue},          % keyword style
  commentstyle=\color{dkgreen},       % comment style
  stringstyle=\color{mauve},         % string literal style
  escapeinside={\%*}{*)},            % if you want to add LaTeX within your code
  morekeywords={*,...}               % if you want to add more keywords to the set
}



\begin{document}

\setlength{\parindent}{0pt} %kein Einzug bei neuen Abschnitten

%-------------------------------	Deckblatt		-----------------------------

\thispagestyle{empty}

\includegraphics[height=2cm]{FULogo.jpg}
\hfill %\hfill wird das "a" am linken Seitenrand, "b" am rechten Seitenrand angeordnet ("a" \hfill "b")
\parbox[b]{0.5\textwidth}{{\large Bachelorarbeit Juli 2012\\}}

\vspace{2cm}

\begin{center}

\rule[11pt]{15cm}{0.5pt}

{ \textbf {\Large Large Scale Parallel Simulation of EPR Lineshape Spectra}}

\rule{15cm}{0.5pt}

\vspace{1cm}

\parbox{15cm}{\small
\textbf{Abstract}: \emph{Electron Paramagnetic Resonance} is a spectroscopy method to examine systems of unpaired electron spins. \emph{Spinach}\footnote{written by Theoretical Spin Dynamics Group, University of Southampton, \url{www.spindynamics.org}} is a Matlab library to simulate different kinds of spin system experiemnts, including EPR. The aim of this work is to make use of Spinach and adopt parallel computing methods on Linux clusters to accelerate the calculation of EPR lineshape spectra.  }

\vspace{0.5cm}

\end{center}

\vspace{1cm}

\large{

{\bf Author:}  Johannes H\"ormann}
\vspace{0.3cm}

{\bf Supervisor:} Hossam Elgabarty

\vspace{1cm}

%\begin{figure}[h!]
%	\centering
%	\includegraphics[width=0.6\textwidth]{screenshot1-546nm.jpg}
%	\caption{Fabry-Perot fringes of 546nm line, no magnetic influence}
%	\label{fringes-546nm}
%\end{figure}

\newpage
\tableofcontents

\vfill
\hfill \today 

%------------------------------------------------------------

\newpage

\section{Mathematical methods}
First of all, we are going to introduce several theoretical concepts necessary to understand the mechanisms of EPR and numerical spectra computation.

\subsection{Fourier transorm}
%\begin{comment}
What happens during EPR from a quite general point of view? We excite a certain system with an electromagnetic signal and measure the system's response. In other words, the system $\Phi$ uses the time-resolved input $x(t)$ to generate output $y(t)$:
\begin{equation}
	y(x) = \Phi\{x(t)\}
\end{equation}
If we assume the system to be linear
\begin{equation}
 	\Phi\{\alpha x_1(t) + \beta x_2(t)\} = \alpha y_1(t) + \beta y_2(t)
\end{equation}
and time-invariant
\begin{equation}
	\Phi\{x(t-t_0)\} = y(t-t_0)
\end{equation}
we can expand the input function in a series of some orthonormal basis set $g_k(t)$, or in some integral transform in the continuous limit with basis $g(\tau,t)$ and define the system completely by its set of responses to the basis functions:
\begin{align}
	x(t) & = \sum_k \chi_k g_k(t) = \int_{-\infty}^{\infty} \chi(\tau) g(\tau,t) d\tau \\
	\Rightarrow \Phi{x(t)} & = \sum_k \chi_k \Phi\{g_k(t)\} = \int_{-\infty}^{\infty} \chi(\tau) \Phi\{g(\tau,t)\} d\tau
\end{align}
Using the definition of the Dirac delta function and applying our LTI (linear time-invariant) system
\begin{align}
	x(t) & =  \int_{-\infty}^{\infty} x(\tau) \delta(\tau-t) d\tau \\
	\Rightarrow 	\Phi\{x(t)\} & =  \int_{-\infty}^{\infty} x(\tau) \Phi\{\delta(\tau-t)\} d\tau = \int_{-\infty}^{\infty} x(\tau) h(\tau-t) d\tau = x(t) * h(t)
\end{align}
we find the system's output to be the convolution of the input wit its \emph{pulse response} or \emph{free induction decay (FID)} $h(t) = \Phi\{\delta(t)\}$. 
Furthermore, harmonics are eigenfunctions of LTI systems, and the \emph{frequency response} or \emph{spectrum} $H(\omega)$ is just the Fourier transform of the system's FID:
\begin{equation}
	\Phi\{e^{i\omega t}\} = \int_{-\infty}^{\infty} e^{i\omega t} h(\tau-t) d\tau =  e^{i\omega t} \int_{-\infty}^{\infty} e^{i\omega (\tau-t)} h(\tau-t) d\tau =  e^{i\omega t} \int_{-\infty}^{\infty} e^{i\omega (\tau)} h(\tau) d\tau = H(\omega) e^{i \omega t}
\end{equation}
%\end{comment}

%INSERT: x-y-component of FID

\subsection{Matrix formalism}

\subsubsection{Diagonizable matrices}
An $n \times n$ matrix $A$ is said to be diagonizable if there exists an invertible matrix $P$ such that
\begin{equation}
 P^{-1} A P = \begin{pmatrix} 
		\lambda_1 & & & \\
		& \lambda_2 & & \\
		& & \text{...} & \\
		& & & \lambda_n
              \end{pmatrix} = D
\end{equation}
If so, then 
\begin{equation}
 A P = P \begin{pmatrix} 
		\lambda_1 & & & \\
		& \lambda_2 & & \\
		& & \text{...} & \\
		& & & \lambda_n
              \end{pmatrix} = P D
\end{equation}
and by writing $P$ composed by its column vectors $P = ( \vec{\alpha}_1 \vec{\alpha}_2 ... \vec{\alpha}_n)$ we find for every $i = 1,2,...,n$
\begin{equation}
 A \vec{\alpha}_i = \lambda_i \vec{\alpha_i}
\end{equation}
Obviously $P$ is made up by the eigenvectors of $A$, while the entries of its diagonalized form $D$ are its eigenvalues. Furthermore, for an $n \times n$ matrix $A$ to possess exactly $n$ distintc eigenvalues is a sufficient condition for diagonalizabilty.

Diagonizable matrices are of interest because once diagonalized their powers can be computet in a very efficient manner:
\begin{align*}
 A^k & = (P D P^{-1})^k = ( P D P^{-1}) \cdot ( P D P^{-1}) \cdot ... \cdot (P D P^{-1}) \\
    & = P D (P^{-1} P) D (P^{-1} P) \cdot ... \cdot (P^{-1} P) D P^{-1} \\
    & = P D^k P^{-1}
\end{align*}
while the power of a diagonal matrix is just
\begin{equation}
 D^k = \begin{pmatrix} 
		\lambda_1 & & & \\
		& \lambda_2 & & \\
		& & \text{...} & \\
		& & & \lambda_n
              \end{pmatrix}^k = 
	\begin{pmatrix} 
		\lambda_1^k & & & \\
		& \lambda_2^k & & \\
		& & \text{...}^k & \\
		& & & \lambda_n^k
              \end{pmatrix}
\end{equation}
Also matrix exponentials can be computed in this way, since they can be expanded as power series such as below.

\subsubsection{Matrix exponentials}
In the following we shall make use of matrix exponentials to express some quantum mechanical operators. The defintion of the exponential
\begin{equation}
 e^x = \sum_{k=0}^\infty \frac{x^k}{k!} = 1 + x + \frac{x^2}{2} + \frac{x^3}{6} + ...
\end{equation}
can be easily applied to square matrices, eg.:
\begin{equation}
 e^{i \phi A } = I + i \phi A - \frac{(\phi A)^2}{2!} - i \frac{(\phi A)^3}{3!} + \frac{(\phi A)^4}{4!} + i \frac{(\phi A)^5}{5!} - ...
\end{equation}

\begin{comment}
Only if the operators $A$ and $B$ commute, the classical identities
\begin{align}
 Ae^{iB} = e^{iB}A \\
  e^{i(A+B)} = e^{iA}e^{iB}
\end{align}
hold.
\end{comment}

\subsection{Spin formalism}
Though the basic mechanisms of EPR can be understood on the basis of a semi classical approach, a quantum mechanical approach is necessary to account for many more subtle features. Here one finds a short introduction to the quantum mechanical formalism involved in EPR theory. 
%According to \cite[Chap. 3]{nmr-ox}, the four basic concepts of the quantum mechanics involved to describe spin behaviour are:
\subsubsection{Quantum states and measurments done on them}
Any allowed spin state $| \Psi \rangle$ can be written as a linear superposition of an orthogonal basis set of an Hilbert vector space spanned by all allowed \emph{azimuthal quantum number} states $| m \rangle$:
\begin{equation}
 | \Psi \rangle = \sum_m a_m | m \rangle 
\label{eq-orthonormal-basis}
\end{equation}
where the amplitudes are complex $a_m = |a_m| e^{i\phi_m}$ with phase $\phi_m$ and magnitude $|a_m|$. The $|m\rangle$ can be represented by a proper scaled basis of choice, but the $m$ lable offers a general independant representation.
 
All measurements to be done on a spin system yield eigenvalues of a linear operator associated with the particular measurement. The corresponding observed physical quantity is called \emph{observable}. Measuring the spin component of a system in one of the basis states along the z-axis $S_z$ thus yields
\begin{equation}
  S_z |m\rangle = m |m\rangle
\end{equation}
The orthogonal basis can be normalized by requiring the inner product of basis vectors to be
\begin{equation}
 \langle m|m'\rangle = \delta_{m m'}
  \label{eq-orthonormality}
\end{equation}

\begin{comment}
This requirement automatically defines the corresponding \emph{bras} for the \emph{ket} states. For a system of $S=\frac{1}{2}$ and thus $m=\pm \frac{1}{2}$ we have
\begin{align} 
 |\tfrac{1}{2}\rangle = \begin{bmatrix} 1 \\ 0 \end{bmatrix}, \quad |-\tfrac{1}{2}\rangle = \begin{bmatrix} 0 \\ 1 \end{bmatrix}\\
 \langle\tfrac{1}{2}| = \begin{bmatrix} 1 & 0 \end{bmatrix}, \quad \langle-\tfrac{1}{2}| = \begin{bmatrix} 0 & 1 \end{bmatrix} 
\end{align}
yielding the operator for the spin z-component observable 
\begin{equation}
 S_z = \begin{bmatrix} \tfrac{1}{2} & 0 \\ 0 & -\tfrac{1}{2} \end{bmatrix}
\end{equation}
\end{comment}

If a spin system exists in the eigenstate $|m\rangle$ of $S_z$, then the measurement of $S_z$ will yield
\begin{equation}
 \langle m | S_z | m \rangle = m
\end{equation}
The measurement on a general superposition will yield
\begin{align}
 \langle \Psi | S_z | \Psi \rangle & = \sum_{m,m'} a_m^* a_{m'} \langle m' | S_z | m \rangle\\
  & = \sum_{m,m'} a_m^* a_{m'} m \langle m' | m \rangle\\
  & = \sum_{m} |a_{m}|^2  m
\end{align}
due to the orthormality of the basis set.

\subsubsection{Density operator and spin ensembles}
%Slichter S. 157ff
Due to equation (\ref{eq-orthonormal-basis}) the expectation value of an observable $A$ can be expressed as 
\begin{equation}
 \langle A \rangle = \langle \psi | A | \psi \rangle = \sum_{m,n} c_m^* c_n \langle m | A | n \rangle
  \label{eq-observable-representation}
\end{equation}
Now, when the expectation value of a certain observable is required, we are always interested in the product $c_m^* c_n$ rather than the distinct $c_n$, thus we can think of a matrix representation of those probabilities and define an operator $P$ with
\begin{equation}
 \langle n | P | m \rangle = c_n c_m^*
\end{equation}
Equation (\ref{eq-observable-representation}) becomes
\begin{equation}
 \langle A \rangle = \sum_{m,n} \langle n | P | m \rangle \langle m | A | n \rangle
  \label{eq-P-A-representation}
\end{equation}
Since $|m\rangle$ form an orthonormal basis set, the results of $A$ and $P$ acting on a basis vector can be expanded in the basis:
% \langle l | P | m \rangle = a_l due to orthononormality
\begin{align} 
 P|m\rangle & = \sum_l a_l |l\rangle = \sum_l \langle l | P | m \rangle | l \rangle\\
 A|n\rangle & = \sum_m a_m |m\rangle = \sum_m \langle m | A | n \rangle | m \rangle\\
 \Rightarrow P A |n\rangle & = \sum_m P|m\rangle \langle m | A | n \rangle \\
  & = \sum_{l,m} |l\rangle \langle l | P | m \rangle \langle m | A | n \rangle \\
  \Rightarrow \langle n | P A | n \rangle & = \sum_{l,m} \langle n|l\rangle \langle l | P | m \rangle \langle m | A | n \rangle \\
  & = \sum_{l,m} \delta_{ln} \langle l | P | m \rangle \langle m | A | n \rangle \\
  & = \sum_{m} \langle n | P | m \rangle \langle m | A | n \rangle
\end{align}
Comparing with equation (\ref{eq-P-A-representation}) we find
\begin{equation}
 \langle A \rangle = \sum_n \langle n | P A | n \rangle = Tr(P A) = Tr(A P)
 \label{eq-A-P-trace}
\end{equation}
where $Tr$ is the trace -- the total sum of the matrix' diagonal elements.

%Slichter S. 159, Callaghan S. 78
In EPR we pulse a powder sample. Theoretically this means a measurement on an ensemble of many spin systems with many (most generally different) spin states $|\psi\rangle$ instead of determining the state of a single system. The observable averaged about the whole statistical ensemble is written as
\begin{align}
 \overline{\langle A \rangle} & = \overline{\langle \psi | A | \psi \rangle} \\
  & = \sum_\psi p_\psi \langle \psi | A | \psi \rangle \\ 
  & = \sum_\psi p_\psi \left( \sum_{m,n} c_m^* c_n \langle m | A | n \rangle \right) \\
  & = \sum_{m,n} \left( \sum_\psi p_\psi c_m^* c_n \right) \langle m | A | n \rangle \\
  & = \sum_{m,n} \overline{c_m^* c_n} \langle m | A | n \rangle
  \label{eq-ensemble-representation}
\end{align}
where $p_\psi$ is an appropriate statistical averaging weight chosen according to the occupancy of $|\psi\rangle$. On this basis we introduce the \emph{density matrix operator}
\begin{equation} 
 \langle n | \rho | m \rangle = \overline{c_m^* c_n} = \overline{\langle n | P | m \rangle}
\end{equation}
whereby equation (\ref{eq-ensemble-representation}) can be expressed in analogy to equation (\ref{eq-A-P-trace}) as
\begin{equation}
 \overline{\langle A \rangle} = \sum_{n,m} \langle n | \rho | m \rangle \langle m | A | n \rangle = \sum_{n} \langle n | \rho A | n \rangle = Tr(\rho A) = Tr(A \rho)
\end{equation}
Another beautiful expression for the density matrix can be derived by noticing that
\begin{align}
 \langle n |\psi \rangle \langle \psi | m \rangle & = \langle n | \left( \sum_{n'} c_{n'} |n' \rangle \right) \left( \sum_{m'} c_{m'}^* \langle m' | \right) | m \rangle \\ & = \sum_{n',m'} c_{n'} c_{m'}^* \langle n | n' \rangle \langle m' | m \rangle = c_n^* c_m  = \langle n | P | m \rangle \\
  \Rightarrow |\psi\rangle\langle\psi| & = P \quad; \quad \overline{|\psi\rangle\langle\psi|}  = \rho
\label{eq-density-matrix}
\end{align}

\subsubsection{Liouville equation}
% Kuprov L9
Under comparison with the general Schr\"odinger equation and its complex conjugate below
\begin{align}
 \langle \psi | \frac{\partial}{\partial t} |\psi\rangle  & = -i \langle \psi | \mathcal{H} |\psi\rangle \\
  \left( \frac{\partial}{\partial t} \langle \psi | \right)  |\psi\rangle
   & = \sum_{m,n} \frac{\partial c_m^*}{\partial t} c_n \langle m | n \rangle 
   =  \sum_{m} \frac{\partial c_m^*}{\partial t} c_m \\
   & = \left( \sum_{m} c_m^* \frac{\partial c_m}{\partial t}\right)^*
   = \left( \langle \psi | \frac{\partial}{\partial t} |\psi\rangle \right)^* = i \langle \psi |\mathcal{H} |\psi\rangle
\end{align}
the density matrix' equation of motion can be derived by differentiating equation (\ref{eq-density-matrix}) with respect to time:
\begin{align}
 \frac{\partial}{\partial t} \rho & = \left( \frac{\partial}{\partial t} | \psi \rangle \right) \langle \psi | + | \psi \rangle \left( \frac{\partial}{\partial t} \langle \psi | \right)  \\
  & = - i \mathcal{H} |\psi\rangle\langle\psi| + i |\psi\rangle\langle\psi| \mathcal{H}  \\
  & = -i ( \mathcal{H} \rho - \rho \mathcal{H} ) = -i [ \mathcal{H}, \rho ] 
  \label{eq-liouville}
\end{align}

\subsubsection{Dynamics}
In case of a stationary Hamiltonian, the Schr\"odinger equation 
\begin{equation}
  i \frac{\partial}{\partial t} | \psi(t) \rangle = \mathcal{H} |\psi(t) \rangle
\end{equation}
has the solution
\begin{equation}
  |\Psi(t)\rangle = U(t) | \psi(0) \rangle
\end{equation}
where 
\begin{equation}
 U(t) = e^{-i \mathcal{H} t}
  \label{eq-evolution}
\end{equation}
is called the \emph{evolution operator}.
Equivalently, the Liouville equation has the solution
\begin{equation}
 \rho(t) = |\psi(t)\rangle \langle \psi(t)| = e^{-i \mathcal{H} t} | \psi(0) \rangle \langle \psi(0) | e^{i \mathcal{H} t} = e^{-i \mathcal{H} t} \rho(0) e^{i \mathcal{H} t}
\end{equation}

In case of a time-dependent, but piecewise-constant Hamiltonian the solution has the form
\begin{equation}
 |\Psi(t)\rangle = \left[ \prod_k e^{-i\mathcal{H}_k \Delta t_k} \right] |\Psi(0)\rangle
\end{equation}

\subsection{Superoperators, Liouville space}
The Hamiltonian $\mathcal{H}$ is an operation defined on the space of vectors, similarly the commutation operator $\mathcal{L} = [\mathcal{H}, \cdot ]$ is an operation defined on the space of operators. Thus it is called the \emph{Liouvillian superoperator}. Therefore, the spaces one usually comes to deal with when treating spin dynamics are

\begin{itemize}
 \item the space where all states live. States are represented as a vector (\ref{eq-orthonormal-basis}) of dimension $N$, and with the scalar product $\langle \phi | \psi \rangle$ they fulfill every requirement to span an $N$-dimensional \emph{Hilbert space}. This space is isomorph to $\mathbb{C}^N$.
  \item the space where all operators which act on spin states live. Operators such as $\mathcal{H}$ are represented by $N\times N$-matrices, thus the space spanned by those operators is $N^2$-dimensional and isomorph to $\mathbb{C}^{N^2}$. There exist many possible scalar products, so again we deal with a Hilbert space. The special operator space, where we choose $Tr(A^\dagger B)$ as the scalar product is known as the \emph{Liouville space} in spin dynamics.
  \item the space where all \emph{superoperators} which act on operators live. Superoperators such as $\mathcal{L} = [\mathcal{H}, \cdot ]$ are represented by $N^2 \times N^2$ matrices, thus the space spanned by those superoperators is $N^4$-dimensional and isomorph to $\mathbb{C}^{N^4}$. Again, we chose the scalar product $Tr(A^\dagger B)$ for this Hilbert and call it \emph{superoperator space}.
\end{itemize}

Now, if we represent states as vectors and operators as matrices, how come we do not have to represent superoperators as more complex objects like ``three-dimensional matrices''? The mathematical trick is to stretch the original operator matrix $\rho$ column-wise into a vertical vector:
\begin{equation}
 \rho = \begin{pmatrix} \vec{\rho}_1,\vec{\rho}_2,\ldots,\vec{\rho}_N \end{pmatrix} \rightarrow
  |\rho \rangle = \begin{pmatrix} \vec{\rho}_1 \\ \vec{\rho}_2 \\ \ldots \\ \vec{\rho}_N \end{pmatrix} 
\end{equation}
Of course, every single column vector of $\rho$ has dimension $N$, so $|\rho\rangle$ has dimension $N^2$. The trace of two matrices $A$, $B$ stretches into a vector scalar product:
\begin{equation}
 Tr( A^\dagger B ) = \sum_{n,k} A_{nk}^* B_{nk} = \sum_{n'} A_{n'}^* B_{n'} = \langle A | B \rangle
\end{equation}
This allows the calculation of a matrix scalar product in $O(N^2)$ runtime.

With the operator stretched into a vector, the superoperator can accordingly be stretched into an $N^2 \times N^2$ matrix representation. The matrix version of the Liouvillian is the sum of two Kronecker products
\begin{equation}
 \mathcal{L} = E \otimes \mathcal{H}^T - \mathcal{H} \otimes E
\end{equation}
%insert proof
where $E$ is the $N \times N$ unity matrix. 

\subsubsection{Choice of basis set and irreducible spherical tensors}
When we are looking for a suitable basis of the Liouville space to conduct some spin dynamics simulation, the perfect choice would be \emph{eigenoperators} $S_k$ of the Liouvillian, since they are invariant under all interactions of the system:
\begin{equation}
  \mathcal{L} S_k = l_k S_k
\end{equation}
To find those eigenoperators in their vector form, one could diagonalize the Liouvillians matrix representation. Unfortunately the computation costs would be enourmous due to the $N^4$ dimensions of the Liouville space. A wise choice would be a set of eigenoperators invariant under commutation with $J_z$, since this operator characterizes the dominating Zeeman interaction in EPR. Or even better, a set of operators invariant under rotations, since we have to examine the spin system from many different angles to average the powder spectrum.

%Slichter S. 490
As we know, the angular momentum operators $J_x$, $J_y$ and $J_z$ generate rotations. It is possible to define a family of operators $T_{lm}$ called \emph{irreducible spherical tensors (IST)}, which fulfill the commutation relations
\begin{align}
 [J_\pm,T_{lm}] & = \sqrt{l(l+1)-m(m\pm1)} T_{l(m\pm1)} \\
  [J_z, T_{lm}] & = m T_{lm}
  \label{eq-tlm-commutators}
\end{align}
In the space of operators they are the analogon to the spherical harmonics in the space of wavefunctions, for every $l$ there exist $2l+1$ independent IST with $m = -l, -l+1, \dots , l-1, l$ and any rotation transforms $T_{lm}$ into a linear combination of $T_{lm'}$ with same $l$:
%Starting from the commutation relations (\ref{eq-tlm-commutators}), it can be shown that a rotation of $T_{lm}$ results in 
\begin{equation}
 R(\alpha,\beta,\gamma) \ T_{lm} = \sum_{m'=-l}^l \mathfrak{D}_{m',m}^{(l)}(\alpha,\beta,\gamma) \ T_{lm'}
\end{equation}
The matrix elements $\mathfrak{D}_{m,m'}^{(l)}(\alpha.\beta,\gamma)$ are called \emph{Wigner functions} and make up the \emph{Wigner rotation matrix} of rank $l$ corresponding to a certain rotation $R(\alpha,\beta,\gamma)$




\subsubsection{}
All operators are square matrices, which might or might not exhibit symmetric features. It will prove handy to express those \emph{tensors} as a composition of a symmetric, \emph{isotropic} part and the \emph{anisotropic} deviation from perfect spherical symmetry. A totally isotropic tensor has only one eigenvalue and can be reduced to a scalar. 


\section{$\tfrac{\pi}{2}$-pulsed EPR}
The mechanisms of \emph{EPR (Electron Paramegnetic Resonance)}, also called \emph{ESR (Electron Spin Resonance)}, work analogous to the mechanisms of \emph{NMR (Nuclear Magnetic Resonance)}. In diamagnetic materials, all electrons are spin-paired, making the magnetic dipole vanish, and enabling the system to be accessible by NMR, and according to \cite[Chap. 4, p. 107]{nmr-ox}, NMR technique offer two further ``advantages'' in comparison with EPR: First, relaxation time of spin electrons is very short compared with nuclei; second the nuclear spin Hamiltonian offers a broader diversity of interactions giving insight to the system's properties. Nevertheless, EPR experiments are suitable to investigate systems with unpaired electrons, which exhibit a non-zero electron spin. The basic idea is to perturb a spin system's equilibrium by a small pulsed oscillating magnetic field and record the emitted radiation during the relaxation process. 

When we place a spin sytem inside a static magnetic field $\vec{B}_0 = B_0 \hat{z}$ and let it settle to equilibrium, due to Zeeman effect more electron spins are goint to align parallel to $\vec{B}_0$ than antiparallel, resulting in a net magnetization of the system. The pulse $\vec{B}_1 = B_1 \hat{x} e^{i(\vec{k}\cdot\vec{r}-\omega_1 t} \cdot u(t_0-t)$ linearly polarized in x-direction will tilt the electron spins and disturb the equilibrium in a way we are going to examine in the following:

\subsection{Spin system Hamiltonian}
The Hamiltonian of an unpaired spin electron system will exhibit several perturbation terms of different nature:
\begin{equation}
 \mathcal{H} = \left[\mathcal{H}_{EZ} + \mathcal{H}_{ECS} + \mathcal{H}_{LS}\right] + \left[\mathcal{H}_{HF}\right] + \left[\mathcal{H}_{NZ} + \mathcal{H}_{NCS} + \text{weaker interactions}\right]
\end{equation}
\begin{enumerate}
  \item \uline{Electron Zeeman contribution} $\mathcal{H}_{EZ} = - \vec{\mu} \cdot \vec{B}_0 = -\hbar B_0 (\gamma_L \mathbf{L}_z + \gamma_S \mathbf{S}_z)$

  The static magnetic field $\vec{B}_0 = B_0 \hat{z}$ acts a torque on the electron's magnetic dipole moment $\mu$, linearly dependant on its angular momentum and spin. Thus the \emph{Zeeman effect} lifts the spin degeneracy of energy levels, reducing the energy of spins aligned parallel to the magnetic field (-), and increasing the energy of spins aligned antiparallel (+) by the correction term
  \begin{equation}
   E^1_\pm = \pm \mu_B \gamma_J B_0 m_J 
  \end{equation}
  resulting from algebraic acrobatics with the Hamiltonian above \cite[insert]{griffiths}.
  Boltzmann statistics yields the relation for the equilibrium occupancy of states
  \begin{equation}
    \frac{N_+}{N_-} = e^{- \frac{\Delta E}{k_B T}}
  \end{equation}

  \item \uline{Electron Chemical shift} $\mathcal{H}_{ECS} = \gamma_S \hbar \mathbf{S} \cdot \sigma_S(t) \cdot \vec{B}_0$
  
  The moving electron clouds change the effective magnetic field $\vec{B}_\text{eff}$ ``seen'' by the every electron spin. This ``shielding'' behaviour is desctribed by the \emph{chemical shift tensor} $\sigma_S(t)$:
  \begin{equation}
    \vec{B}_\text{eff}(t) = - \sigma_S(t) \cdot \vec{B}_0
  \end{equation}

  \item \uline{Spin-orbit coupling} $\mathcal{H}_{LS} = \lambda \mathbf{L}\cdot \mathbf{S}$

  The electron's motion around the nucleus creates a magnetic field, with which the electron's spin will interact. 
  Together with the Zeeman interaction, those to Hamiltonian contributions are due to the influence of a magnetic field. Furthermore, the externam Zeeman field causes $\vec{L}$ to change, thus also influencing the spin-orbit interaction.

  \item \uline{Hyperfine interaction} $\mathcal{H}_{HF} = \frac{\gamma_I \gamma_S \hbar^2}{r^3} \left[ \frac{3 (\mathbf{I} \cdot \vec{r}(t) ) (\mathbf{S} \cdot \vec{r}(t) )}{r^2} - \mathbf{I} \cdot \mathbf{S} \right]$
   
  The nucleus interacts with the orbiting electron due to the electron's induced magnetic field acting on the nuclear magnetic dipole moment. 

  \item \uline{Nuclear Zeeman contribution} $\mathcal{H}_{NZ} = -\hbar B_0 \gamma_I \mathbf{I}_z$
  
  Just like the electron, the nucleus posseses intrinsic spin and thus a nuclear magnetic moment, enabling it to interact with an external magnetic field.

  \item \uline{Nuclear chemical shift} $\mathcal{H}_{NCS} = \gamma_I \hbar \mathbf{I} \cdot \sigma_I(t) \cdot \vec{B}_0$
  
  Of course, the shielding by the electron clouds also applies to the nuclei's spins $\mathbf{I}$.
  \begin{equation}
    \vec{B}_\text{eff}(t) = - \sigma_I(t) \cdot \vec{B}_0
  \end{equation}

  \item \uline{Other weaker interactions} like coupling of the nuclear quadrupole moment to the electron's electromagnetic field and the magnetic coupling of electrons with each other or nuclei with each other are neglected in this work.
\end{enumerate}

\subsection{g-tensor and A-tensor}
  In the spin Hamiltonian above different interactions have been grouped with square brackets into three packages. The latter package $\left[\mathcal{H}_{NZ} + \mathcal{H}_{NCS} + \text{weaker interactions}\right]$ simply marks interactions which we are allowed to neglect in the case of high field EPR. When the external magnetic field $\vec{B}_0$ becomes sufficiently strong, their contribution diminishes in comparison with the interactions depending on $\vec{B}_0$.

  The former package $\left[\mathcal{H}_{EZ} + \mathcal{H}_{ECS} + \mathcal{H}_{LS}\right]$ marks major interactions linear in spin. In EPR the overall behaviour of those interactions is summarized in the \emph{g-tensor}:
  \begin{equation}
    \mathcal{H}_\text{linear} = \mu_B \mathbf{S} \cdot g \cdot \vec{B}_0
  \end{equation}

  The second package only including the hyperfine interaction characterizes the term bilinear in spin: the coupling between one spin and another. Though not evident from the sketch above, but those interactions are anisotropic in general and thus summarized by the A-tensor in the case of EPR:
  \begin{equation}
    \mathcal{H}_\text{bilinear} = \mathbf{S} \cdot A \cdot \mathbf{I}
  \end{equation}

  Those interaction tensors are diagonizable matrices. Assume the $3 \times 3$ g-tensor has three eigenvalues $g_{xx}$, $g_{yy}$ and $g_{zz}$ on his diagonal. $g$ is called rhombic in the common case $g_{xx} \neq g_{yy} \neq g_{zz}$. In the special case $g_{xx} = g_{yy} = g_{zz}$ g is said to be \emph{isotropic}. In EPR practice, g and other tensors are usually quantified by their isotropic part and the anisotropic deviation from it:
\begin{align}
 g_\text{iso} & = \frac{1}{3} Tr(g) = \frac{1}{3} (g_{xx} + g_{yy} + g_{zz})\\
 g_\text{aniso} & = g - g_\text{iso} \cdot I
\end{align}
where $I$ is the identity matrix.


\subsubsection{Rotating reference frame}
A magnetic field $B_0$ applied along the z-axis causes a magnetic moment to precess around the z-axis at the Larmor frequency $\omega_0$. Since the electron's magnetic moment is proportional to its angular momentum $\vec{\mu} = \gamma \vec{J}$ with the \emph{Land\'e g-factor} $\gamma$, the interaction energy $E = - \vec{\mu} \cdot \vec{B}$ and thus the Hamiltonian, the evolution operator and the Schr\"odinger equation's solution can be expressed as
\begin{equation}
  \mathcal{H} = - \gamma B_0 J_z, \quad U(t) = e^{i \gamma B_0 t J_z}, \quad \Psi(t) = e^{i \gamma B_0 t J_z} \Psi(0) = e^{i \omega_0 t J_z} \Psi(0) \quad \text{with} \quad \omega_0 = \gamma B_0
\end{equation}
Analogous to the classical approach, the time dependent solution must be a rotation of the initial state by angle $phi = -\omega_0 t$, and we can identify 
\begin{equation}
 R_z(\phi) = e^{-i\phi J_z}
\label{eq-z-rotation}
\end{equation}
as an rotation operator around the z-axis. $\phi > 0$ results in an \emph{active} rotation of the state in ``positive'', anticlockwise direction, whereas $\phi < 0$ results in  a rotation in ``negative'', clockwise direction. Likewise we can speak of $\phi > 0$ causing a \emph{passive} rotation of the reference frame in negative, clockwise direction, whereas $\phi < 0$ rotates the reference frame in positive, anticlockwise direction.

Suppose we are changing from the lab frame to a frame which is rotating anticlockwise with angular velocity $\omega_1$ around the z-Axis. 
The passive clockwise rotation by $\omega_1 t$ converting from rotating frame to inertial frame is realized by the operator $R_z(\omega_1 t) = e^{-i \omega_1 t I_z}$, while an passive anticklockwise transition from lab frame to rotating frame is realized by the operator $R_z(-\omega_1 t) =  e^{i \omega_1 t I_z}$. Thus we can apply any operator $A$ we know in the inertial frame, packed in a sandwich of rotational operators $R(-\omega_1 t) A R(\omega_1 t)$, to receive the value of an observable in the rotating frame. Let's convert the Hamiltonian to our rotating frame:
\begin{equation}
 \mathcal{H}_\text{rot} = e^{i \omega_1 t I_z} \mathcal{H} e^{-i \omega_1 t I_z}
\end{equation}
We transform the Schr\"odinger equation for wave $|\Phi(t)\rangle$ to the rotating frame with the rotated wave function $|\Phi'(t)\rangle$:
\begin{align} 
  i\frac{\partial}{\partial t} |\Phi'(t)\rangle   & = \mathcal{H} |\Phi'(t)\rangle  \\
  \Rightarrow i \frac{\partial}{\partial t} \left(e^{-i \omega_1 t I_z} |\Phi'(t)\rangle \right) & = \left( e^{-i \omega_1 t I_z} \mathcal{H}_\text{rot} e^{i \omega_1 t I_z} \right) \left( e^{-i \omega_1 t I_z} |\Phi'(t)\rangle \right)
  %\Leftrightarrow 
\end{align}
%GRAPHICS%
Differentiating the equation's left hand side and rearranging yields
\begin{align}
 i\frac{\partial}{\partial t} |\Phi'(t)\rangle & = (\mathcal{H}_\text{rot} - \omega_1 I_z) |\Phi'(t)\rangle \\
  & = \mathcal{H}' |\Phi'(t)\rangle \quad \text{with} \quad \mathcal{H}' = e^{i \omega_1 t I_z} \mathcal{H} e^{-i \omega_1 t I_z} - \omega_1 I_z
  \label{eq-rotating-hamiltonian}
\end{align}


\subsection{Resonant frequency field}
Suppose we observe the equilibrium system due to Zeeman interaction $\mathcal{H} = - \gamma B_0 I_z$ from a rotating frame. According to equation (\ref{eq-rotating-hamiltonian})
\begin{equation}
  \mathcal{H'} = -\gamma(B_0 + \frac{\omega_1}{\gamma}) I_z
\end{equation}
the rotating frame introduces another term acting like an additional magnetic field. By choosing the angular velocity to equal the Zeeman effect's Larmor frequency $\omega_1 = -\gamma B_0$ we can make the net magnetic field vanish in the rotating frame. This is easy to imagine: The rotating frame just follows the system's Larmor precession, letting it appear stationary.

Now switching on the pulse $B_1$ in x-direction modifies the lab frame Hamiltonian\footnote{see \cite[Chap. 4.2.2 The resonant radiofrequency field, p.111f]{nmr-ox}}
\begin{equation}
 \mathcal{H} = - \gamma B_0 I_z - 2 \gamma B_1 \cos(\omega_1 t) I_x
\end{equation}
and the rotating frame Hamiltonian
\begin{equation}
  \mathcal{H}' = - \gamma ( B_0 + \frac{\omega_1}{\gamma}I_z) - \gamma B_1 I_x
\end{equation}
At resonant frequency the field in z-direction vanishes and the field component in x-direction causes a simple precession of the system's spin around the magnetic field axis at frequency $\omega_2 = - \gamma B_1$ in the rotating frame. Choosing an appropriate duration of the pulse $\omega_2 t_p = \tfrac{\pi}{2}$, the equilibrium magnetisation of the sample will be disturbed, since the system's spins are all tilted by $90^\circ$ around the x-axis into the x-y-plane. 

\subsection{Experimental setup}

\section{Spinach}
The Matlab library \emph{Spinach} supplies efficient methods for large-scale spin dynamics simulations. It consists of the \emph{kernel} with the implementation of general spin dynamics simulation techniques and the \emph{user-land} with a collection of different experiements to perform. Basically, the user prepares the description of a spin system, which is then translated by the kernel into the most efficient basis sets, superoperators, etc. The user-land decides how to deal with those objects, whether to apply a pre-established experiment, or whether to perform the kernel's simulation procedures manually. Though Spinach is able to simulate numerous kinds of experiments, in this work we are going to restrict ourselves to standard EPR experiments. 

%Cerf S.20
Using the theoretical basis introduced above, the procedure of an EPR simulation comes down to the following key steps:
\begin{enumerate}
 \item Spinach constructs the isotropic and anisotropic part of the Liouvillian ...
 \item ... and calculates the evolution of the density matrix through the pulse secquence and afterwards by propagating the Liouville equation (\ref{eq-liouville}), ...
 \item ...then determines the transversal magnetization deppending on $S_+$, a superposition of spin in x- and y-direction, at acquisition time using equation (\ref{}).
\end{enumerate}

For the $\pi$-pulsed EPR, the user-land readily provides the method \verb|pulse_acquire|. 


In the following the preparation of input data and computation flow are summarized, such that the idea where to implement parallelization becomes obvious.

\subsection{A Spinach EPR Simulation}
\subsubsection{Typical input file}
This file prepares a typical spin system and conducts a $\pi$-pulsed EPR experiment on it. The data structure \verb$sys$ contains information about the spin system and the experimental setup, \verb$inter$ represents the linear and bilinear interactions of the spins, \verb$bas$ specifies the state basis set to be used and \verb$parameters$ specifies the enquired simulation results. 
\begin{lstlisting}
function jlh_3spins()

% Set the simulation parameters
sys.magnet=3.356;
sys.regime='powder';
bas.mode='ESR-1';
sys.tols.grid_rank=101;
\end{lstlisting} 
Specifies $B_0 = 3.356 T$ and tells Spinach to average the spectrum over uniformly distributed orientations in a ``powder''. The mode ``ESR-1'' generates a complete state space for all electrons, but reduces the state space for all nuclei in a certain way to be efficient enough and still yield reasonable EPR results. The grid rank $101$ chooses a certain Lebedev grid of orientations to average about.
\begin{lstlisting}[firstnumber=last]
% Interactions
sys.isotopes={'E','14N', '1H'};
inter.zeeman.matrix=cell(3,1);
inter.zeeman.matrix{1,1}=[ 2.0056023 -0.0013775 -0.0004019; -0.0008185 2.0038816 0.0002087; -0.0002747 0.0001729 2.0062982];
inter.coupling.matrix=cell(3,3);
inter.coupling.matrix{1,2}=1e6*[29.4479  3.9997 -0.4979;   3.9997  76.1445 -14.8367;  -0.4979 -14.8367  38.4285];  %92.815191
inter.coupling.matrix{1,3}=1e6*[-1.2922  2.0819 -1.9943;  2.0819  -1.407 -1.7023; -1.9943 -1.7023 -1.5011];  %5.3217912
\end{lstlisting}
Advises Spinach to prepare a spin system of an unpaired electron, a nitrogen nucleus and a proton spin. The Zeeman matrix states the $3\times 3$ g-Tensor, while the coupling matrices state the $3\times 3$ A-tensors accounting for the hyperfine interactions between electron spin and all other spins.
\begin{lstlisting}[firstnumber=last]
% Set the sequence parameters
parameters.offset=0;
parameters.sweep=1e9;
parameters.npoints=512;
parameters.zerofill=1024;
parameters.spins='E';
parameters.axis_units='Gauss';
parameters.derivative=0;
\end{lstlisting}
Sets parameters for the experiment to simulate: \verb$npoints$ determines the number of time steps in the simulation, \verb$sweep$ chooses the spectral window's width, and thus the duration of one time step, $zerofill$ sets the FID zero-filling and \verb$spins$ selects the spins to be pulsed and detected -- the electron spin in our case.
\begin{lstlisting}[firstnumber=last]
% Run Spinach
spin_system=create(sys,inter);
spin_system=basis(spin_system,bas);
fid=pulse_acquire(spin_system,parameters);
\end{lstlisting}
The first kernel functions to be called are \verb$create(sys,inter)$ and \verb$basis(spin_system,bas)$. Former returns the data structure \verb$spin_system$, which can be handed to the kernel lateron to reference to our spin system, e.g. to fetch the Liouvillian in question.
\verb$pulse_acquire(spin_system, parameters)$ finally conducts the $\pi$-pulsed EPR and returns the time-resolved FID.
\begin{lstlisting}[firstnumber=last]
% Apodization
fid=apodization(fid,'crisp-1d');

% Perform Fourier transform
spectrum=fftshift(fft(fid,parameters.zerofill));

% ...

end
\end{lstlisting}
The ``crisp'' apodization modulates the FID by a declining cosine window function in the interval $[0,\tfrac{\pi}{2}]$
\begin{equation}
 \text{FID}'(t) = \text{FID}(t) \cdot \cos^8 \left( \frac{\pi}{2} \cdot \frac{t}{L_\text{FID}} \right)
\end{equation}
Line 31 finally performs Fast Fourier Transform to generate the frequency domain spectrum.

%Insert graphics about the effect of fft, zero filling and shifting

\subsubsection{pulse\_acquire}

\begin{lstlisting}
function fid=pulse_acquire(spin_system,parameters,L,rho)

%...

% Compute the digitization parameters.
timestep=1/parameters.sweep;

% Generate the basic operators
Lp=operator(spin_system,'L+',parameters.spins);
Ly=(Lp-Lp')/2i;
\end{lstlisting}
The function \verb$operator$ prepares the raising operator $L_+$ and then constructs
\begin{equation}
  L_y = \frac{1}{2i} ( L_+ - L_- ) = \frac{1}{2i} ( L_+ - L_+^\dagger )
\end{equation}
The apostrophe in the Matlab code marks the complex conjugate transposition $L_+^\dagger$ of $L_+$. The relation above can be easily found by realizing that the raising and the lowering operator form a Hermitian conjugate pair $L_- = L_+^\dagger$
%\begin{align}
% L_+ = L_x + i L_y, \quad L_+^\dagger = L_x^\dagger - i L_y^\dagger \\
%  \frac{L_+ - L_+^\dagger}{2i} = \frac{L_y + L_y\dagger}{2}
%\end{align}

\begin{lstlisting}[firstnumber=last]
% Set the secularity assumptions
spin_system=secularity(spin_system,'nmr');

% Start from thermal equilibrium
rho=equilibrium(spin_system);
\end{lstlisting}
The \verb$secularity$ function decides about the importance of interactions. In high field EPR and NMR, only the electrons' states are accounted fore fully, whereas the nuclei's spins are only evaluated in z-direction. Density matrix \verb$rho$ is initialized with the termal equilibrium state of the spin system.

\begin{lstlisting}[firstnumber=last]
[Iso,Q]=h_superop(spin_system);
\end{lstlisting}

The isotropic part of the Liouvillian is stored in \verb$Iso$, while \verb$Q$ is the set of five rank-2 \emph{irreducible spherical tensors} representing the Liouvillian's anisotropic part in the rotational basis. The dimensions of those two matrices determine Spinach's memory consumption.

\begin{lstlisting}[firstnumber=last]
% Get the spherical averaging grid
grid=load([spin_system.sys.root_dir spin_system.sys.slash 'exp' ...
				    spin_system.sys.slash 'grids' ...
				    spin_system.sys.slash 'lebedev_rank_' num2str(spin_system.tols.grid_rank) '.dat'],'ASCII');
grid_size=size(grid,1); phi=pi*grid(:,1)/180; theta=pi*grid(:,2)/180; weight=grid(:,3);
\end{lstlisting}
The Lebedev grid is read from a file holding all precomputed orientations on the unit sphere. The number of points for a Lebedev grid of certain rank can be found in table (\ref{tab-lebedev}).
%Tabelle einfügen!

\begin{lstlisting}[firstnumber=last]
% Get the orientation array
L_aniso=orientation(Q,[phi theta zeros(size(theta))]);
L=blkdiag(L_aniso{:})+kron(speye(grid_size),Iso);
L=clean_up(spin_system,L,spin_system.tols.liouv_zero);
\end{lstlisting}
\verb$orientation$ rotates the anisotropic part of the Liouvillian in the rotational basis by the specified Euler angles and creates a cell array of operators, one for each orientation. The Liouvillian block matrix \verb$L$ has a diagonal element for every Lebedev orientation $n$:
\begin{equation}
 L= L_{\text{aniso}} + I \otimes L_\text{iso} =
	      \begin{pmatrix} 
		L_{\text{aniso},1} & & & \\
		& L_{\text{aniso},2} & & \\
		& & \text{...} & \\
		& & & L_{\text{aniso},n}
              \end{pmatrix} +
	      \begin{pmatrix} 
		1 & & & \\
		& 1 & & \\
		& & \text{...} & \\
		& & & 1
              \end{pmatrix} \otimes L_\text{iso}
\end{equation}

\begin{lstlisting}[firstnumber=last]
% Get the initial and the detection states
rho=kron(ones(grid_size,1),rho);
coil=kron(weight,state(spin_system,'L+',parameters.spins));
\end{lstlisting}
The density matrix is duplicated $n$ times in a column vector to propagate one for each orientation, and similarly the observable to be detected is duplicated \underline{and the Lebedev weights are applied} in a column vector \verb$coil$. In the experimental setup the detection coil measures independently the magnetization in x- and y-direction, which correspond to the horizontal spin state $S_+ = S_x + i S_y$, \verb$'L+'$ in Spinach notation.

\begin{lstlisting}[firstnumber=last]
% Apply the pulse
rho=step(spin_system,kron(speye(grid_size),Ly),rho,pi/2);

fid=evolution(spin_system,L,coil,rho,timestep,parameters.npoints-1,'observable');

end
\end{lstlisting}
Generally, \verb$step(spin_system,L,rho,dt)$ propagates the density matrix \verb$rho$ under the influence of a certain Liouvillian \verb$L$ by a time step \verb$dt$. Because \verb$step$ makes uses of the evolution operator (\ref{eq-evolution}) internally, it can conduct a $90^\circ$ rotation around the y-axis by replacing the time step by an angle $\tfrac{\pi}{2}$ and the Liouvillian by the spin operator $L_y$, letting it construct the rotation operator
\begin{equation}
 R_y (\tfrac{\pi}{2}) = e^{-i \tfrac{\pi}{2} L_y}
\end{equation}
in analogy to equation (\ref{eq-z-rotation}). This just rotates all spins into the x-y-plane, just as a $\tfrac{\pi}{2}$-pulse will do. 
Sequently, \verb$evolution$ can be regarded as a sequence of \verb$npoints$ \verb$step$-functions propagating the density matrix through the whole time interval by steps of duration \verb$timestep$ by applying Liouvillian \verb$L$. In addition, the observable \verb$coil$ is evaluated for every single step, recording the time resolved FID with magnetization in x-direction as its real part and magnetization in y-direction as its imaginary part. 

\section{Parallelization}

\subsection{Clusters and platforms}
\subsubsection{Sheldon}
\subsubsection{Soroban}

\subsection{Matlab parallel computing toolbox}
\subsubsection{Matlab licences}
\subsubsection{Matlab - Linux interaction}

\subsection{Spinach modification}
\subsubsection{Master process}
\subsubsection{Child processes}
\subsubsection{Finalization process}

\subsection{Benchmarking}

\section{Conclusion and outlook}

\FloatBarrier
\begin{thebibliography}{9}
\bibitem{spinach}
  Dr. Ilya Kuprov,
  \emph{Spin Dynamics, Lecture 1 - 10}.
  University of Oxford,
  2011.

\bibitem{spinach}
  H.J. Hogben, M. Krzystyniak, G.T.P. Charnock, P.J. Hore, Ilya Kuprov,
  \emph{Spinach - A software library for simulation of spin dynamics in large spin systems}.
  Journal of Magnetic Resonance,
  208 (2011) 179-194.

\bibitem{griffiths}
  David J. Griffiths,
  \emph{Introduction to Quantum Mechanics}.
  Pearson, 
  2nd Edition, 
  2005.

\bibitem{nmr-ox}
  Paul T. Callaghan,
  \emph{Translational Dynamics \& Magnetic Resonance. Principles of Pulsed Gradient Spin Echo NMR}.
  Oxford University Press,
  2011.

\end{thebibliography}

\end{document}